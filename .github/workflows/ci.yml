name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Check for OpenAPI spec updates daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  lint-and-build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
          
      - name: Install dependencies
        run: bun install --frozen-lockfile
        
      - name: Generate API clients
        run: bun run generate
        
      - name: Check for changes
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi
        
      - name: Run TypeScript check
        run: bun run typecheck
        
      - name: Run linter
        run: bun run lint
        
      - name: Build project
        run: bun run build
        
      - name: Create Pull Request for API updates
        if: steps.verify-changed-files.outputs.changed == 'true' && github.event_name == 'schedule'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update Servarr API clients from latest OpenAPI specs'
          title: 'Update Servarr API clients'
          body: |
            ðŸ¤– **Automated OpenAPI Client Update**
            
            This PR contains updated TypeScript clients generated from the latest Servarr OpenAPI specifications.
            
            **Changes:**
            - Regenerated clients from upstream OpenAPI specs
            - Updated type definitions and API methods
            - Maintained backward compatibility where possible
            
            **Verification:**
            - âœ… TypeScript compilation passes
            - âœ… Linting passes
            - âœ… Build succeeds
            
            Please review the changes and merge if everything looks correct.
          branch: chore/update-api-clients
          delete-branch: true